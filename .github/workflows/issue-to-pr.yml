name: Issue → PR (add project)

on:
  issues:
    types: [labeled]

jobs:
  issue-to-pr:
    if: "contains(github.event.issue.labels.*.name, 'add-project')"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Dump issue body
        run: echo "${{ github.event.issue.body }}" > issue-body.txt

      - name: Run parser (write file)
        run: |
          node scripts/issue-to-project.js --input-file issue-body.txt --outdir documentation/src/data/projects

      - name: Compute slug
        id: get_slug
        run: |
          slug=$(node -e "const fs=require('fs');const b=fs.readFileSync('issue-body.txt','utf8');const m=b.match(/Project Name:\s*(.*)/); if(!m){console.log(''); process.exit(0);} const s=m[1].toString().toLowerCase().trim().replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-+|-+$/g,''); console.log(s);")
          echo "slug=$slug" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Add project
          branch: add-project/${{ steps.get_slug.outputs.slug }}
          title: Add project from issue #${{ github.event.issue.number }}
          body: |
            This PR adds a project JSON file generated from issue #${{ github.event.issue.number }}.

      - name: Comment on issue with PR link
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.issue;
            // the create-pull-request action exposes the PR number via outputs on the job - try to find it
            const pr = await github.pulls.list({ owner: context.repo.owner, repo: context.repo.repo, state: 'open' });
            // naive: find PR opened by the bot with matching title
            const title = `Add project from issue #${context.issue.number}`;
            const found = pr.data.find(p => p.title === title);
            const body = found ? `Thanks — a PR has been opened to add this project: ${found.html_url}` : 'Thanks — a PR has been opened to add this project.';
            await github.issues.createComment({ ...issue, body });
